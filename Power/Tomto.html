<!doctype html>
<html>
<head>
Â  <meta charset="utf-8" />
Â  <title>Tomato Leaf Detector</title>
Â  <link rel="stylesheet" href="style.css"> </head>
<body>
Â  <div class="container"> Â  Â  <h1>ğŸ… Tomato Leaf Disease Detection</h1> Â  Â  <div class="content-box">
Â  Â  Â  <h2>Upload / Capture Leaf Image</h2>
Â  Â  Â  <video id="video" autoplay playsinline style="display:none;"></video>
Â  Â  Â  <canvas id="preview" width="640" height="480"></canvas>
Â  Â  Â  <div class="controls">
Â  Â  Â  Â  <input type="file" id="fileInput" accept="image/*" />
Â  Â  Â  Â  <button id="openCam" class="btn primary-btn">Open Camera</button>
Â  Â  Â  Â  <button id="snap" class="btn secondary-btn">Capture</button>
Â  Â  Â  Â  <button id="upload" class="btn primary-btn">Upload for Detection</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div class="content-box">
Â  Â  Â  <h2>Detection Result</h2>
Â  Â  Â  <pre id="result"></pre>
Â  Â  </div>
Â  </div>

<script>
// ... (Your existing JavaScript code remains here, unchanged) ...
const video = document.getElementById('video');
const canvas = document.getElementById('preview');
const ctx = canvas.getContext('2d');
const fileInput = document.getElementById('fileInput');
let stream;

// open camera
document.getElementById('openCam').onclick = async () => {
Â  try {
Â  Â  stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }});
Â  Â  video.srcObject = stream;
Â  Â  video.style.display = 'block';
Â  Â  // Resize canvas to match video stream aspect ratio
Â  Â  video.onloadedmetadata = () => {
Â  Â  Â  const ratio = video.videoWidth / video.videoHeight;
Â  Â  Â  canvas.height = canvas.width / ratio;
Â  Â  Â  video.play();
Â  Â  };
Â  } catch(e) { alert('camera denied: '+e.message); }
};

// capture from video
document.getElementById('snap').onclick = () => {
Â  if (video.srcObject) {
Â  Â  // Set canvas size to current video size for accurate capture
Â  Â  canvas.height = canvas.width * (video.videoHeight / video.videoWidth);
Â  Â  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
Â  Â  // Hide video after capture for a cleaner look
Â  Â  video.style.display = 'none';
Â  Â  if (stream) {
Â  Â  Â  stream.getTracks().forEach(track => track.stop());
Â  Â  Â  stream = null;
Â  Â  Â  video.srcObject = null;
Â  Â  }
Â  }
};

// load file
fileInput.onchange = (e) => {
Â  // Stop camera if running
Â  if (stream) {
Â  Â  stream.getTracks().forEach(track => track.stop());
Â  Â  stream = null;
Â  Â  video.srcObject = null;
Â  Â  video.style.display = 'none';
Â  }

Â  const file = e.target.files[0];
Â  if (!file) return;
Â  const img = new Image();
Â  img.onload = () => {
Â  Â  // Calculate ratio to maintain aspect ratio and fit/fill canvas width
Â  Â  const ratio = img.height / img.width;
Â  Â  canvas.height = canvas.width * ratio;

Â  Â  // Draw image centered on canvas, filling the width
Â  Â  ctx.fillStyle='#f9f9f9'; ctx.fillRect(0,0,canvas.width,canvas.height);
Â  Â  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
Â  };
Â  img.src = URL.createObjectURL(file);
};

// upload canvas image
document.getElementById('upload').onclick = async () => {
Â  // Set canvas back to a standard size for the image blob if it was resized
Â  // For detection, the server might expect a consistent size, but for the blob, 
Â  // its best to use the drawn content's actual dimensions. 
Â  // However, toBlob uses the current canvas state.

Â  // Indicate loading state
Â  document.getElementById('result').textContent = 'Processing...';
Â  document.getElementById('upload').disabled = true;

Â  try {
Â  Â  const blob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', 0.9));
Â  Â  const form = new FormData();
Â  Â  form.append('file', blob, 'capture.jpg');
Â  Â  form.append('field_id', 'field123');
Â  
Â  Â  const resp = await fetch('/api/v1/detect', { method: 'POST', body: form });
Â  Â  const json = await resp.json();
Â  Â  document.getElementById('result').textContent = JSON.stringify(json, null, 2);
Â  } catch (error) {
Â  Â  document.getElementById('result').textContent = 'Error during detection: ' + error.message;
Â  } finally {
Â  Â  document.getElementById('upload').disabled = false;
Â  }
};
</script>
</body>
</html>